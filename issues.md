# Типичные проблемы и решения

> Сборник известных "граблей" и способов их решения

## Проблемы PostgreSQL

### listen_addresses не применяется
**Проблема:** После изменения `listen_addresses` в postgresql.conf подключения извне не работают  
**Решение:** Требуется `systemctl restart postgresql`, reload не помогает

### Проблемы прав владельца после pg_restore
**Проблема:** После восстановления БД из дампа нарушены права доступа  
**Решение:** 
```bash
ALTER DATABASE dbname OWNER TO username;
GRANT ALL PRIVILEGES ON DATABASE dbname TO username;
```

## Проблемы Docker

### Docker-порт проброшен неверно
**Проблема:** Контейнер недоступен снаружи (например 5678:443 вместо 5678:5678)  
**Решение:** Проверить порты в `docker run` или `docker-compose.yml`, исправить маппинг

### Отсутствующие .env файлы
**Проблема:** Docker контейнер не запускается из-за отсутствия переменных окружения  
**Решение:** Проверить наличие `.env` файлов перед запуском, восстановить из бэкапа

### SECURE_COOKIE=true требует HTTPS
**Проблема:** n8n не работает с SECURE_COOKIE=true при HTTP  
**Решение:** Установить `N8N_SECURE_COOKIE=false` для HTTP или настроить HTTPS

## Проблемы Taiga

### 502 Bad Gateway после рестарта taiga-back
**Проблема:** Nginx-gateway кеширует IP taiga-back, после перезапуска получаем 502  
**Решение:** Перезапустить taiga-gateway: `docker compose restart taiga-gateway`  
**Альтернатива:** Добавить в taiga-gateway/taiga.conf: `resolver 127.0.0.11 valid=30s;`

### 403 ACCESS_REFUSED в RabbitMQ
**Проблема:** При смене пароля в .env RabbitMQ отклоняет подключения  
**Решение:** Обновить пароль вручную в контейнерах:
```bash
docker compose exec taiga-async-rabbitmq rabbitmqctl change_password taiga TaigaMqPass!
docker compose exec taiga-events-rabbitmq rabbitmqctl change_password taiga TaigaMqPass!
```

### Статика не обновляется
**Проблема:** CSS/JS файлы не обновляются после изменений  
**Решение:** Удалить том статики и пересоздать:
```bash
docker compose down
docker volume rm taiga-full_taiga-static-data
docker compose up -d
```

## Проблемы MCP Bridge

### "Тишина" в консоли после ./run.sh --sse
**Проблема:** После запуска MCP bridge нет вывода в консоль  
**Решение:** Установить `LOG_FILE=/dev/stdout` в `.env`

### HTTP 307 при обращении к /sse/
**Проблема:** FastAPI редиректит с /sse/ на /sse  
**Решение:** Использовать адрес без конечного слэша: `http://192.168.1.150:8000/sse`

### --sse аргумент игнорируется
**Проблема:** Сервер запускается в stdio режиме вместо HTTP-SSE  
**Решение:** Патч в `src/server.py` для корректного парсинга аргумента `--sse`

## Проблемы сети и SSL

### Hair-pin NAT отсутствует
**Проблема:** Таймауты при обращении изнутри LAN на публичный IP  
**Решение:** Настроить split-DNS через dnsmasq: `address=/n8n.gramini.org/192.168.1.120`

### Certbot ошибки NXDOMAIN и timeout
**Проблема:** Let's Encrypt не может получить сертификат  
**Решение:** 
1. Проверить DNS записи
2. Проверить проброс портов 80/443
3. Использовать `fullchain.pem` вместо `cert.pem`

### При обновлении ядра не поднимаются сетевые интерфейсы
**Проблема:** После обновления ядра PVE пропадает сеть  
**Решение:** Перезагрузка хоста обычно решает проблему

## Проблемы конфликтов пакетов

### Postgres в хосте мешал контейнеру
**Проблема:** PostgreSQL на хосте конфликтует с контейнером  
**Решение:** Удалить пакеты PostgreSQL с хоста: `apt remove postgresql*`

## Проблемы производительности

### NVMe диски греются выше 70°C
**Проблема:** Высокая температура NVMe дисков под нагрузкой  
**Решение:** Мониторить температуру, при необходимости улучшить охлаждение

## Общие рекомендации

### Перед любыми изменениями
1. Создать бэкап конфигурации
2. Проверить наличие свободного места
3. Убедиться в наличии .env файлов
4. Проверить права доступа к файлам

### После изменений проверить
1. Логи сервисов на наличие ошибок
2. Доступность веб-интерфейсов
3. Подключения к базам данных
4. Работу зависимых сервисов

### Диагностика проблем
- **Проверка портов:** `netstat -tlnp | grep :port`
- **Проверка логов:** `journalctl -u service_name -f`
- **Проверка Docker:** `docker logs container_name`
- **Проверка PostgreSQL:** `pg_isready -h host`
- **Проверка nginx:** `nginx -t`

---

**Обновлено:** 2024-12-19
